<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <h1>Personal Finance Tracker</h1>
        <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
    </header>

    <div class="container">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                    {% for category, message in messages %}
                        <li class="flash-{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <!-- Financial Summary -->
        <section class="summary-cards">
            <div class="card income">
                <h3>Total Income</h3>
                <p>${{ "%.2f"|format(total_income) }}</p>
            </div>
            <div class="card expense">
                <h3>Total Expenses</h3>
                <p>${{ "%.2f"|format(total_expense) }}</p>
            </div>
            <div class="card balance">
                <h3>Net Balance</h3>
                <p>${{ "%.2f"|format(net_balance) }}</p>
            </div>
        </section>

        <!-- Main dashboard content -->
        <div class="dashboard-grid">
            <section class="add-transaction card">
                <h2>Add New Transaction</h2>
                <form action="{{ url_for('add_transaction') }}" method="POST">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" name="amount" placeholder="Amount" required min="0" step="0.01">
                    <label for="type">Type:</label>
                    <select id="type" name="type" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    <label for="category">Category:</label>
                    <input type="text" id="category" name="category" placeholder="Category" required>
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                    <label for="description">Description (optional):</label>
                    <textarea id="description" name="description" placeholder="Short description"></textarea>
                    <button type="submit">Add Transaction</button>
                </form>
            </section>

            <!-- Monthly Budgets -->
            <section class="budgets card">
                <h2>Monthly Budgets</h2>
                <div class="add-budget">
                    <form action="{{ url_for('add_budget') }}" method="POST">
                        <input type="text" name="category" placeholder="Category" required>
                        <input type="number" name="amount" placeholder="Budget Amount" required min="0" step="0.01">
                        <button type="submit">Set Budget</button>
                    </form>
                </div>
                <div class="budget-list">
                    {% if budgets_with_spending %}
                        {% for budget in budgets_with_spending %}
                            <div class="budget-item">
                                <div class="budget-info">
                                    <h4>{{ budget.category }}</h4>
                                    <p>${{ "%.2f"|format(budget.spent_amount) }} / ${{ "%.2f"|format(budget.budget_amount) }}</p>
                                </div>
                                <div class="progress-bar-container">
                                    {% set percentage = (budget.spent_amount / budget.budget_amount * 100) if budget.budget_amount > 0 else 0 %}
                                    <div class="progress-bar {% if percentage > 100 %}over-budget{% endif %}" style="width: {{ percentage if percentage <= 100 else 100 }}%;"></div>
                                </div>
                                {% if percentage > 100 %}
                                    <p class="over-budget-text">Over budget!</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>No budgets set for this month. Use the form above to add one.</p>
                    {% endif %}
                </div>
            </section>

            <section class="charts-section card">
                <h2>Financial Insights</h2>
                <div class="chart-container">
                    <canvas id="spendingChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="incomeChart"></canvas>
                </div>
            </section>

            <!-- Transaction History -->
            <section class="history card">
                <h2>Transaction History</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for transaction in transactions %}
                            <tr data-id="{{ transaction.id }}" data-amount="{{ transaction.amount }}" data-type="{{ transaction.type }}" data-category="{{ transaction.category }}" data-date="{{ transaction.date }}" data-description="{{ transaction.description }}">
                                <td>{{ transaction.date }}</td>
                                <td>{{ transaction.description }}</td>
                                <td>{{ transaction.category }}</td>
                                <td class="transaction-type {{ transaction.type }}">{{ transaction.type.capitalize() }}</td>
                                <td class="amount">${{ "%.2f"|format(transaction.amount) }}</td>
                                <td class="action-buttons">
                                    <button class="btn-edit" onclick="showEditModal({{ transaction.id }})"><i class="fas fa-edit"></i></button>
                                    <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" method="POST" style="display: inline;">
                                        <button type="submit" class="btn-delete" onclick="return confirm('Are you sure you want to delete this transaction?')"><i class="fas fa-trash"></i></button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </section>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Edit Transaction</h2>
            <form id="editForm" method="POST">
                <label for="edit_amount">Amount:</label>
                <input type="number" id="edit_amount" name="amount" required min="0" step="0.01">
                <label for="edit_type">Type:</label>
                <select id="edit_type" name="type" required>
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
                <label for="edit_category">Category:</label>
                <input type="text" id="edit_category" name="category" required>
                <label for="edit_date">Date:</label>
                <input type="date" id="edit_date" name="date" required>
                <label for="edit_description">Description (optional):</label>
                <textarea id="edit_description" name="description"></textarea>
                <button type="submit">Update Transaction</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the transaction data from the server-side
            const transactions = JSON.parse('{{ transactions | tojson | safe }}');
            
            // Prepare data for the spending chart (Doughnut Chart)
            const spendingData = {};
            const incomeData = {};

            transactions.forEach(transaction => {
                if (transaction.type === 'expense') {
                    if (spendingData[transaction.category]) {
                        spendingData[transaction.category] += transaction.amount;
                    } else {
                        spendingData[transaction.category] = transaction.amount;
                    }
                } else if (transaction.type === 'income') {
                    if (incomeData[transaction.category]) {
                        incomeData[transaction.category] += transaction.amount;
                    } else {
                        incomeData[transaction.category] = transaction.amount;
                    }
                }
            });

            const spendingLabels = Object.keys(spendingData);
            const spendingValues = Object.values(spendingData);

            const incomeLabels = Object.keys(incomeData);
            const incomeValues = Object.values(incomeData);

            // Chart for Expenses (Doughnut Chart)
            if (spendingValues.length > 0) {
                const spendingChart = new Chart(document.getElementById('spendingChart'), {
                    type: 'doughnut',
                    data: {
                        labels: spendingLabels,
                        datasets: [{
                            data: spendingValues,
                            backgroundColor: ['#d9534f', '#f0ad4e', '#5bc0de', '#5cb85c', '#337ab7', '#2a354c']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Expenses by Category'
                            }
                        }
                    }
                });
            } else {
                const ctx = document.getElementById('spendingChart').getContext('2d');
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('No expense data available', document.getElementById('spendingChart').width / 2, document.getElementById('spendingChart').height / 2);
            }

            // Chart for Income (Bar Chart)
            if (incomeValues.length > 0) {
                const incomeChart = new Chart(document.getElementById('incomeChart'), {
                    type: 'bar',
                    data: {
                        labels: incomeLabels,
                        datasets: [{
                            label: 'Income by Category',
                            data: incomeValues,
                            backgroundColor: '#4caf50',
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Income by Category'
                            },
                            tooltip: {
                                enabled: true
                            }
                        }
                    }
                });
            } else {
                const ctx = document.getElementById('incomeChart').getContext('2d');
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('No income data available', document.getElementById('incomeChart').width / 2, document.getElementById('incomeChart').height / 2);
            }
        });

        // Edit Modal functionality
        const modal = document.getElementById('editModal');
        const closeModalBtn = document.querySelector('.close-btn');
        const editForm = document.getElementById('editForm');

        function showEditModal(transactionId) {
            const row = document.querySelector(`tr[data-id='${transactionId}']`);
            if (row) {
                document.getElementById('edit_amount').value = row.dataset.amount;
                document.getElementById('edit_type').value = row.dataset.type;
                document.getElementById('edit_category').value = row.dataset.category;
                document.getElementById('edit_date').value = row.dataset.date;
                document.getElementById('edit_description').value = row.dataset.description;
                editForm.action = `/edit_transaction/${transactionId}`;
                modal.style.display = 'block';
            }
        }

        closeModalBtn.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>

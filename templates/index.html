<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance Tracker Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome for dark mode icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <header>
        <div class="header-container">
            <h1>Personal Finance Tracker</h1>
            <div class="header-actions">
                <button id="theme-toggle" class="btn-icon" aria-label="Toggle dark mode">
                    <!-- Icon will be set by JavaScript -->
                </button>
                <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
            </div>
        </div>
    </header>
    <div class="container">
        <!-- Flash messages for user feedback -->
        <ul class="flashes">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </ul>
        <div class="dashboard-grid">
            <section class="add-transaction card">
                <h2>Add New Transaction</h2>
                <form action="{{ url_for('add_transaction') }}" method="POST">
                    <label for="amount">Amount:</label>
                    <input type="number" id="amount" name="amount" placeholder="Amount" required min="0" step="0.01">
                    
                    <label for="type">Type:</label>
                    <select id="type" name="type" required>
                        <option value="expense">Expense</option>
                        <option value="income">Income</option>
                    </select>
                    
                    <label for="category">Category:</label>
                    <input type="text" id="category" name="category" placeholder="e.g., Groceries, Salary" required>
                    
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                    
                    <label for="description">Description (Optional):</label>
                    <textarea id="description" name="description" placeholder="Short description"></textarea>
                    
                    <button type="submit" class="btn-primary">Add Transaction</button>
                </form>
            </section>
            <section class="summary-section card">
                <h2>Financial Summary</h2>
                <p>Total Income: <span class="income">${{ '%.2f' % total_income }}</span></p>
                <p>Total Expenses: <span class="expense">${{ '%.2f' % total_expenses }}</span></p>
                <p>Net Balance: <span class="{{ 'income' if (total_income - total_expenses) >= 0 else 'expense' }}">${{ '%.2f' % (total_income - total_expenses) }}</span></p>
            </section>
        </div>

        <!-- New section for monthly budgets -->
        <section class="budget-section card">
            <h2>Monthly Budgets</h2>
            <div class="budget-grid">
                <!-- Form to set new budgets -->
                <form action="{{ url_for('set_budget') }}" method="POST" class="budget-form">
                    <h3>Set a Budget</h3>
                    <label for="budget-category">Category:</label>
                    <input type="text" id="budget-category" name="category" placeholder="e.g., Groceries" required>
                    <label for="budget-limit">Budget Limit:</label>
                    <input type="number" id="budget-limit" name="limit" placeholder="$0.00" required min="0" step="0.01">
                    <button type="submit" class="btn-primary">Set Budget</button>
                </form>
                
                <!-- Display existing budgets and progress -->
                <div class="budget-list">
                    <h3>Your Budgets</h3>
                    {% if budget_data %}
                        {% for category, limit in budget_data.items() %}
                            {% set spent = expense_data_dict.get(category, 0) %}
                            <div class="budget-item">
                                <div class="budget-item-header">
                                    <h4>{{ category.capitalize() }}</h4>
                                    <p>${{ '%.2f' % spent }} / ${{ '%.2f' % limit }}</p>
                                </div>
                                <div class="progress-bar-container">
                                    {% set progress_percentage = (spent / limit * 100) if limit > 0 else 0 %}
                                    <div class="progress-bar" style="--progress: {{ progress_percentage|int }}%;"></div>
                                </div>
                                {% if spent > limit %}
                                    <p class="budget-status expense">Over budget! (by ${{ '%.2f' % (spent - limit) }})</p>
                                {% elif spent > limit * 0.8 %}
                                    <p class="budget-status warning">Close to budget!</p>
                                {% else %}
                                    <p class="budget-status income">On track</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="no-data-message">No budgets set yet.</p>
                    {% endif %}
                </div>
            </div>
        </section>

        <section class="transaction-history card">
            <h2>Transaction History</h2>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Category</th>
                        <th>Description</th>
                        <th class="amount-col">Amount</th>
                        <th class="action-col" colspan="2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr data-id="{{ transaction.id }}" 
                        data-amount="{{ transaction.amount }}"
                        data-type="{{ transaction.type }}"
                        data-category="{{ transaction.category }}"
                        data-date="{{ transaction.date }}"
                        data-description="{{ transaction.description }}">
                        <td>{{ transaction.date }}</td>
                        <td class="{{ transaction.type }}">{{ transaction.type.capitalize() }}</td>
                        <td>{{ transaction.category }}</td>
                        <td>{{ transaction.description }}</td>
                        <td class="amount-col">${{ '%.2f' % transaction.amount }}</td>
                        <td class="action-col">
                            <button class="btn-edit" onclick="showEditModal(this)" data-transaction-id="{{ transaction.id }}">Edit</button>
                        </td>
                        <td class="action-col">
                            <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                                <button type="submit" class="btn-danger">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not transactions %}
                    <tr>
                        <td colspan="7" class="no-data-message">No transactions recorded yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </section>

        <section class="charts-section card">
            <h2>Spending & Income Analysis</h2>
            <div class="chart-flex-container">
                <div class="chart-container">
                    <canvas id="spendingChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="incomeChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <!-- Hidden Edit Transaction Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content card">
            <div class="modal-header">
                <h2>Edit Transaction</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-form" method="POST">
                <label for="edit-amount">Amount:</label>
                <input type="number" id="edit-amount" name="amount" required min="0" step="0.01">
                
                <label for="edit-type">Type:</label>
                <select id="edit-type" name="type" required>
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
                
                <label for="edit-category">Category:</label>
                <input type="text" id="edit-category" name="category" required>
                
                <label for="edit-date">Date:</label>
                <input type="date" id="edit-date" name="date" required>
                
                <label for="edit-description">Description:</label>
                <textarea id="edit-description" name="description"></textarea>
                
                <div class="modal-buttons">
                    <button type="submit" class="btn-primary">Save Changes</button>
                    <button type="button" class="btn-cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden elements to safely pass data from Flask to JavaScript -->
    <div id="data-container" 
         data-expense-data="{{ expense_data | tojson | safe }}"
         data-income-data="{{ income_data | tojson | safe }}">
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Dark Mode Logic ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const body = document.body;
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            function setIcon(isDark) {
                themeToggleBtn.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            }

            function applyTheme(isDark) {
                if (isDark) {
                    body.classList.add('dark-mode');
                    setIcon(true);
                } else {
                    body.classList.remove('dark-mode');
                    setIcon(false);
                }
            }

            // Check for user's saved preference or system preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                applyTheme(savedTheme === 'dark');
            } else {
                applyTheme(prefersDarkScheme.matches);
            }

            // Listen for changes in system preference
            prefersDarkScheme.addEventListener('change', (e) => {
                applyTheme(e.matches);
            });

            // Toggle theme on button click
            themeToggleBtn.addEventListener('click', () => {
                const isDark = body.classList.toggle('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                setIcon(isDark);
            });

            // --- Chart Initialization (Existing code) ---
            const dataContainer = document.getElementById('data-container');
            const expenseData = JSON.parse(dataContainer.dataset.expenseData);
            const incomeData = JSON.parse(dataContainer.dataset.incomeData);

            function createChartOrMessage(elementId, type, label, data, backgroundColor, noDataMessage) {
                const ctx = document.getElementById(elementId).getContext('2d');
                if (data.length > 0) {
                    new Chart(ctx, {
                        type: type,
                        data: {
                            labels: data.map(item => item[0]),
                            datasets: [{
                                label: label,
                                data: data.map(item => item[1]),
                                backgroundColor: backgroundColor,
                                borderColor: backgroundColor,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top',
                                },
                                tooltip: {
                                    enabled: true
                                }
                            }
                        }
                    });
                } else {
                    ctx.font = '16px "Segoe UI", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(noDataMessage, ctx.canvas.width / 2, ctx.canvas.height / 2);
                }
            }
            
            createChartOrMessage(
                'spendingChart',
                'doughnut',
                'Expenses by Category',
                expenseData,
                ['#e74c3c', '#f39c12', '#3498db', '#2ecc71', '#9b59b6'],
                'No expense data available'
            );

            createChartOrMessage(
                'incomeChart',
                'bar',
                'Income by Category',
                incomeData,
                '#27ae60',
                'No income data available'
            );

            // --- Modal and Edit Logic (Existing code) ---
            const editModal = document.getElementById('edit-modal');
            const editForm = document.getElementById('edit-form');
            const closeButton = document.querySelector('.close-modal');
            const cancelButton = document.querySelector('.btn-cancel');

            window.showEditModal = function(editButton) {
                const transactionId = editButton.dataset.transactionId;
                const transactionRow = document.querySelector(`tr[data-id="${transactionId}"]`);
                
                const amount = transactionRow.dataset.amount;
                const type = transactionRow.dataset.type;
                const category = transactionRow.dataset.category;
                const date = transactionRow.dataset.date;
                const description = transactionRow.dataset.description;

                document.getElementById('edit-amount').value = amount;
                document.getElementById('edit-type').value = type;
                document.getElementById('edit-category').value = category;
                document.getElementById('edit-date').value = date;
                document.getElementById('edit-description').value = description;

                editForm.action = `{{ url_for('edit_transaction', transaction_id=0) }}`.replace('0', transactionId);

                editModal.style.display = 'flex';
            };

            function closeEditModal() {
                editModal.style.display = 'none';
            }

            closeButton.addEventListener('click', closeEditModal);
            cancelButton.addEventListener('click', closeEditModal);
            
            window.addEventListener('click', (event) => {
                if (event.target === editModal) {
                    closeEditModal();
                }
            });
        });
    </script>
</body>
</html>
